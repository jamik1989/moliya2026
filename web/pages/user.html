<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FORTEL</title>

  <link rel="stylesheet" href="../assets/css/app.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    window.DASH_BRAND = {
      name: "SHOHASAR",
      primary: "#D62828",
      accent: "#111827",
      logoUrl: "../assets/img/logo.png"
    };
  </script>

  <style>
    .abc-legend{
      margin: 20px;
      background:#fff;
      border:1px solid #eaeaea;
      border-radius:12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.06);
      overflow:hidden;
    }
    .abc-legend-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:14px 16px;
      background: #f8f9fa;
      border-bottom:1px solid #eee;
    }
    .abc-legend-title{
      font-weight:800;
      color:#2c3e50;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .abc-legend-title small{
      font-weight:600;
      color:#6c757d;
    }
    .abc-legend-toggle{
      border:none;
      background:transparent;
      cursor:pointer;
      font-weight:700;
      color:#3498db;
      padding:6px 8px;
      border-radius:10px;
    }
    .abc-legend-body{
      padding:14px 16px;
      color:#444;
      line-height:1.55;
      font-size:14px;
    }
    .abc-legend-body.hidden{ display:none; }
    .abc-chip{
      display:inline-block;
      padding:3px 10px;
      border-radius:999px;
      font-weight:800;
      font-size:12px;
      margin:0 6px 6px 0;
      border:1px solid #e6e6e6;
      background:#f8f9fa;
    }
    .abc-note{
      margin-top:10px;
      font-size:13px;
      color:#666;
    }
  </style>
</head>

<body>
  <div class="main-container">

    <div class="topbar" style="display:flex;align-items:center;justify-content:space-between;padding:10px 15px;background:#fff;">
      <div style="font-weight:700;">FORTEL</div>

      <button id="logoutBtn" class="logout-btn" type="button"
        style="border:1px solid #ddd;border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer;">
        <i class="fas fa-sign-out-alt"></i> Chiqish
      </button>
    </div>

    <!-- ✅ CHANGE PASSWORD PANEL -->
    <div style="background:#fff;margin:12px 15px;padding:12px;border:1px solid #eee;border-radius:12px;">
      <div style="font-weight:800;margin-bottom:8px;display:flex;align-items:center;gap:8px;">
        <i class="fas fa-key"></i> Parolni o‘zgartirish
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <input id="oldPass" type="password" placeholder="Eski parol"
          style="flex:1;min-width:200px;padding:10px;border:1px solid #ddd;border-radius:10px;" />
        <input id="newPass" type="password" placeholder="Yangi parol (min 4)"
          style="flex:1;min-width:200px;padding:10px;border:1px solid #ddd;border-radius:10px;" />
        <button id="changePassBtn" type="button"
          style="padding:10px 14px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer;font-weight:700;">
          O‘zgartirish
        </button>
      </div>

      <div id="changePassMsg" style="margin-top:10px;font-size:14px;display:none;padding:10px;border-radius:10px;"></div>
    </div>

    <!-- NAVIGATION -->
    <div class="navigation">
      <button class="nav-btn active" data-tab="calculator">
        <i class="fas fa-calculator"></i> Kalkulyator
      </button>
      <button class="nav-btn" data-tab="abc">
        <i class="fas fa-chart-network"></i> ABC-XYZ
      </button>
      <button class="nav-btn" data-tab="monthly">
        <i class="fas fa-chart-line"></i> Oylik
      </button>
    </div>

    <!-- ⚠️ Sizning real dashboard kontentingiz shu yerda bo‘lishi kerak -->
    <!-- Hozir bu faylda yo‘q. Agar siz eski to‘liq user.html’ni tashlasangiz,
         men hammasini ichiga qo‘shib, to‘liq qilib qaytaraman. -->

  </div>

  <script src="../assets/js/app.js" defer></script>
  <script src="../assets/js/utils/formatters.js" defer></script>
  <script src="../assets/js/modules/calc.js" defer></script>
  <script src="../assets/js/utils/columnMapper.js" defer></script>
  <script src="../assets/js/modules/abcxyz.js" defer></script>
  <script src="../assets/js/modules/monthly.js" defer></script>

  <!-- ✅ API_BASE config (defer shart) -->
  <script src="/config.js" defer></script>

  <script>
    // ✅ Auth check: config.js yuklangandan keyin ishlaydi
    async function authCheck() {
      window.API_BASE = window.API_BASE || "";
      try {
        const res = await fetch(window.API_BASE + "/api/me", { credentials: "include" });
        if (!res.ok) return window.location.replace("login.html");
      } catch (e) {
        return window.location.replace("login.html");
      }
    }

    // config.js defer bo‘lgani uchun DOMContentLoaded ichida chaqiramiz
    document.addEventListener("DOMContentLoaded", authCheck);
  </script>

  <!-- ✅ CHANGE PASSWORD JS -->
  <script>
    const cpMsgBox = document.getElementById("changePassMsg");
    const cpBtn = document.getElementById("changePassBtn");

    function showCP(type, text) {
      if (!cpMsgBox) return;
      cpMsgBox.style.display = "block";
      cpMsgBox.textContent = text;
      cpMsgBox.style.background = (type === "ok") ? "#e8f8ef" : "#ffeaea";
      cpMsgBox.style.color = (type === "ok") ? "#1e8449" : "#c0392b";
    }

    if (cpBtn) {
      cpBtn.addEventListener("click", async () => {
        window.API_BASE = window.API_BASE || "http://127.0.0.1:3000";

        const oldPassword = document.getElementById("oldPass").value;
        const newPassword = document.getElementById("newPass").value;

        if (!oldPassword || !newPassword) {
          return showCP("err", "Eski va yangi parolni kiriting");
        }
        if (newPassword.length < 4) {
          return showCP("err", "Yangi parol kamida 4 ta bo‘lsin");
        }
        if (oldPassword === newPassword) {
          return showCP("err", "Yangi parol eski parol bilan bir xil bo‘lmasin");
        }

        cpBtn.disabled = true;
        const oldText = cpBtn.textContent;
        cpBtn.textContent = "Tekshirilmoqda...";

        try {
          const res = await fetch(window.API_BASE + "/api/change-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ oldPassword, newPassword })
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok || !data.ok) {
            showCP("err", data.message || "Xato");
            return;
          }

          showCP("ok", data.message || "Parol yangilandi. Logout qilib yangi parol bilan kiring.");
          document.getElementById("oldPass").value = "";
          document.getElementById("newPass").value = "";
        } catch (e) {
          showCP("err", "Serverga ulanib bo‘lmadi");
        } finally {
          cpBtn.disabled = false;
          cpBtn.textContent = oldText;
        }
      });
    }
  </script>
</body>
</html>
