<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FORTEL - Admin</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    *{ box-sizing:border-box; font-family:system-ui; }
    body{ margin:0; background:#f4f6fb; min-height:100vh; padding:18px; }
    .wrap{ max-width:1100px; margin:0 auto; }

    .top{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      background:#fff; border:1px solid #eaeaea; border-radius:14px;
      padding:12px 14px; box-shadow:0 5px 15px rgba(0,0,0,0.06);
    }
    .title{ font-weight:900; display:flex; align-items:center; gap:10px; }

    .btn{
      border:1px solid #ddd; background:#fff; cursor:pointer;
      border-radius:10px; padding:8px 12px; font-weight:900;
    }
    .primary{ border-color:#b8c6ff; color:#2c4bff; }
    .danger{ border-color:#ffb3b3; color:#c0392b; }

    .grid{ display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px; }
    .card{
      background:#fff; border:1px solid #eaeaea; border-radius:14px;
      padding:14px; box-shadow:0 5px 15px rgba(0,0,0,0.06);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .inp{
      padding:10px; border-radius:10px; border:1px solid #ddd;
      min-width:220px; flex:1;
    }
    .msg{
      margin-top:10px; padding:10px; border-radius:10px; display:none;
      font-size:14px;
    }
    .msg.err{ display:block; background:#ffeaea; color:#c0392b; }
    .msg.ok{ display:block; background:#e8f8ef; color:#1e8449; }

    table{ width:100%; border-collapse:collapse; margin-top:12px; font-size:14px; }
    th, td{ border-bottom:1px solid #eee; padding:10px; text-align:left; vertical-align:middle; }
    th{ background:#fafafa; font-weight:900; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .small{ padding:6px 10px; border-radius:9px; font-weight:900; }
    .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    .hide{ display:none !important; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="title"><i class="fa-solid fa-user-shield"></i> Admin panel</div>
    <div class="row" style="justify-content:flex-end;">
      <button class="btn" id="goLogin"><i class="fa-solid fa-arrow-left"></i> Login</button>
      <button class="btn" id="refreshBtn"><i class="fa-solid fa-rotate"></i> Yangilash</button>
      <button class="btn danger" id="adminLogoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Admin chiqish</button>
    </div>
  </div>

  <div class="grid">

    <!-- ADMIN LOGIN -->
    <div class="card" id="adminLoginCard">
      <div style="font-weight:900;margin-bottom:8px;">Admin kirish</div>
      <div class="row">
        <input id="aUser" class="inp" placeholder="Admin username" />
        <input id="aPass" class="inp" type="password" placeholder="Admin password" />
        <button class="btn primary" id="adminLoginBtn"><i class="fa-solid fa-lock"></i> Kirish</button>
      </div>
      <div class="msg" id="adminLoginMsg"></div>
      <div style="margin-top:10px;color:#666;font-size:13px;">
        Admin login faqat <b>users.json</b> ichidagi <b>role: "admin"</b> bo‘lgan foydalanuvchi.
      </div>
    </div>

    <!-- CREATE USER -->
    <div class="card hide" id="createCard">
      <div style="font-weight:900;margin-bottom:8px;">Yangi foydalanuvchi qo‘shish</div>
      <div class="row">
        <input id="cuUser" class="inp" placeholder="username (faqat harf/son/._-)" />
        <input id="cuPass" class="inp" type="password" placeholder="password (min 4)" />
        <input id="cuPhone" class="inp" placeholder="phone (+998...)" />
        <button class="btn primary" id="createBtn"><i class="fa-solid fa-plus"></i> Qo‘shish</button>
      </div>
      <div class="msg" id="createMsg"></div>
    </div>

    <!-- USERS TABLE -->
    <div class="card hide" id="tableCard">
      <div style="font-weight:900;margin-bottom:8px;">Foydalanuvchilar</div>
      <div class="msg" id="tableMsg"></div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Username</th>
              <th>Password</th>
              <th>Phone</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tb"></tbody>
        </table>
      </div>
      <div style="margin-top:10px;color:#666;font-size:13px;">
        Eslatma: Sizning talab bo‘yicha password ochiq ko‘rsatilmoqda.
      </div>
    </div>

  </div>
</div>

<script>
const API = "";

const goLogin = document.getElementById("goLogin");
goLogin.onclick = () => location.href = "login.html";

const refreshBtn = document.getElementById("refreshBtn");
refreshBtn.onclick = () => loadUsers();

const adminLogoutBtn = document.getElementById("adminLogoutBtn");
adminLogoutBtn.onclick = async () => {
  try { await fetch(API + "/api/admin/logout", { method:"POST", credentials:"include" }); } catch {}
  lockAdminUI();
  alert("Admin chiqdi");
};

const adminLoginCard = document.getElementById("adminLoginCard");
const createCard = document.getElementById("createCard");
const tableCard = document.getElementById("tableCard");

const adminLoginMsg = document.getElementById("adminLoginMsg");
const createMsg = document.getElementById("createMsg");
const tableMsg = document.getElementById("tableMsg");
const tb = document.getElementById("tb");

function showMsg(el, type, text){
  el.className = "msg " + type;
  el.textContent = text;
}

function unlockAdminUI(){
  adminLoginCard.classList.add("hide");
  createCard.classList.remove("hide");
  tableCard.classList.remove("hide");
}

function lockAdminUI(){
  adminLoginCard.classList.remove("hide");
  createCard.classList.add("hide");
  tableCard.classList.add("hide");
  tb.innerHTML = "";
}

async function checkAdminSession(){
  try{
    const res = await fetch(API + "/api/admin/me", { credentials:"include" });
    if (!res.ok) return lockAdminUI();
    unlockAdminUI();
    loadUsers();
  }catch{
    lockAdminUI();
  }
}

document.getElementById("adminLoginBtn").onclick = async () => {
  const username = document.getElementById("aUser").value.trim();
  const password = document.getElementById("aPass").value;

  if (!username || !password) return showMsg(adminLoginMsg, "err", "Admin login va parolni kiriting");

  try{
    const res = await fetch(API + "/api/admin/login", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      credentials:"include",
      body: JSON.stringify({ username, password })
    });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data.ok) return showMsg(adminLoginMsg, "err", data.message || "Xato");

    showMsg(adminLoginMsg, "ok", "Admin kirdi");
    unlockAdminUI();
    loadUsers();
  }catch{
    showMsg(adminLoginMsg, "err", "Serverga ulanib bo‘lmadi");
  }
};

document.getElementById("createBtn").onclick = async () => {
  const username = document.getElementById("cuUser").value.trim();
  const password = document.getElementById("cuPass").value;
  const phone = document.getElementById("cuPhone").value.trim();

  if (!username || !password || !phone) return showMsg(createMsg, "err", "Username, password, phone majburiy");
  if (password.length < 4) return showMsg(createMsg, "err", "Parol kamida 4 ta bo‘lsin");

  try{
    const res = await fetch(API + "/api/admin/create-user", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      credentials:"include",
      body: JSON.stringify({ username, password, phone })
    });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data.ok) return showMsg(createMsg, "err", data.message || "Xato");

    showMsg(createMsg, "ok", "User qo‘shildi");
    document.getElementById("cuUser").value = "";
    document.getElementById("cuPass").value = "";
    document.getElementById("cuPhone").value = "";
    loadUsers();
  }catch{
    showMsg(createMsg, "err", "Serverga ulanib bo‘lmadi");
  }
};

async function resetPassword(username){
  const newPassword = prompt("Yangi parol (min 4):");
  if (!newPassword) return;
  if (newPassword.length < 4) return alert("Parol kamida 4 ta bo‘lsin");

  const res = await fetch(API + "/api/admin/reset-password", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    credentials:"include",
    body: JSON.stringify({ username, newPassword })
  });
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data.ok) return alert(data.message || "Xato");

  alert("Parol yangilandi");
  loadUsers();
}

async function deleteUser(username){
  if (!confirm("Rostdan ham o‘chirasizmi? (" + username + ")")) return;

  const res = await fetch(API + "/api/admin/users/" + encodeURIComponent(username), {
    method:"DELETE",
    credentials:"include"
  });
  const data = await res.json().catch(()=> ({}));
  if (!res.ok || !data.ok) return alert(data.message || "Xato");

  alert("User o‘chirildi");
  loadUsers();
}

async function loadUsers(){
  tb.innerHTML = "";
  showMsg(tableMsg, "ok", "Yuklanmoqda...");

  try{
    const res = await fetch(API + "/api/admin/users", { credentials:"include" });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok || !data.ok) return showMsg(tableMsg, "err", data.message || "Admin login qiling");

    showMsg(tableMsg, "ok", "OK: " + data.users.length + " ta user");

    tb.innerHTML = data.users.map(u => `
      <tr>
        <td class="mono">${escapeHtml(u.username)}</td>
        <td class="mono">${escapeHtml(u.password)}</td>
        <td class="mono">${escapeHtml(u.phone || "")}</td>
        <td>
          <div class="actions">
            <button class="btn small primary" data-reset="${escapeAttr(u.username)}">Reset</button>
            <button class="btn small danger" data-del="${escapeAttr(u.username)}">Delete</button>
          </div>
        </td>
      </tr>
    `).join("");

    tb.querySelectorAll("[data-reset]").forEach(b => {
      b.addEventListener("click", () => resetPassword(b.getAttribute("data-reset")));
    });
    tb.querySelectorAll("[data-del]").forEach(b => {
      b.addEventListener("click", () => deleteUser(b.getAttribute("data-del")));
    });

  }catch{
    showMsg(tableMsg, "err", "Serverga ulanib bo‘lmadi");
  }
}

function escapeHtml(s){
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function escapeAttr(s){
  return escapeHtml(s).replaceAll("`","&#96;");
}

checkAdminSession();
</script>
</body>
</html>
